<!DOCTYPE html>

{% extends 'base_build.html' %}
{% block content %}
<div class="list-wrapper">
  <div class="list"> <h2><b> High </b></h2>
    <div id="bot" class="list">
      <div id="left" class="list"></div>
    </div>
  </div>

  <div class="list"><h2><b> Medium </b></h2>
    <div id="bot" class="list">
      <div id="center" class="list"></div>
    </div>
    <button id="submit" class="btn btn-primary btn-lg btn-block list middle" disabled="disabled">RANK!</button>

  </div>

  <div class="list"><h2><b> Low </b></h2>
    <div id="bot" class="list">
      <div id="right" class="list"></div>
    </div>
  </div>

</div>



<script>
    function getRankedObjects(){
        var left = Array.from(document.querySelector('#left').children).map(x => x.innerText)
        var center = Array.from(document.querySelector('#center').children).map(x => x.innerText)
        var right = Array.from(document.querySelector('#right').children).map(x => x.innerText)
        return left.concat(center).concat(right)
    }

    var min_num_of_non_empty_lists = 2

    var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            var num_of_non_empty_list = document.querySelector('#center').children.length > 0 ? 1 : 0
            num_of_non_empty_list += document.querySelector('#left').children.length > 0 ? 1 : 0
            num_of_non_empty_list += document.querySelector('#right').children.length > 0 ? 1 : 0

            if (num_of_non_empty_list < min_num_of_non_empty_lists){
                $('#submit').attr('disabled', 'disabled');
            }
            else {
                $('#submit').removeAttr('disabled');
            }
        });
    });

    // Node, config
    var observerConfig = {
        childList: true,
    };

    var center_node = document.getElementById('center');
    var left_node = document.getElementById('left');
    var right_node = document.getElementById('right');

    observer.observe(center_node, observerConfig);
    observer.observe(left_node, observerConfig);
    observer.observe(right_node, observerConfig);

function handleSubmit() {
  const pwl = generatePairwise()
  sendPostRequest(pwl)
}
function generatePairwise() {
  const high = Array.from(document.querySelectorAll('#left .object')).map(x => x.id)
  const med = Array.from(document.querySelectorAll('#center .object')).map(x => x.id)
  const low = Array.from(document.querySelectorAll('#right .object')).map(x => x.id)
  // pairwise list to send back to server
  let pwl = []
  for (let i = 0; i < high.length; i++) {
    for (let j = 0; j < med.length; j++) {
      pwl.push({ 'high': high[i], 'low': med[j] })
    }
    for (let j = 0; j < low.length; j++) {
      pwl.push({ 'high': high[i], 'low': low[j] })
    }
  }
  for (let i = 0; i < med.length; i++) {
    for (let j = 0; j < low.length; j++) {
      pwl.push({ 'high': med[i], 'low': low[j] })
    }
  }
  console.log(pwl)
  return pwl
}
function sendPostRequest(pwl) {
  const dataset_name = '{{dataset_name}}'
  const url = '/build/submit/'
  const xhr = new XMLHttpRequest()
  xhr.open('POST', url, true)
  xhr.setRequestHeader('Content-type', 'application/json')
  // xhr.onload()
  xhr.send(JSON.stringify({
    dataset_name: dataset_name,
    pairs: pwl
  }))
  xhr.onload = function () {
    document.write(this.response)
  }
}
document.querySelector('#submit').addEventListener('click', handleSubmit)
</script>
{% endblock %}
